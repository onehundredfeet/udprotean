image: haxe:4.0-stretch

stages:
- build-test
- deploy

build-cs:
  stage: build-test
  variables:
    HXML: hxml/build-cs.hxml
  script:
  # Install dotnet sdk 3.0
  - apt-get update
  - apt-get install -yqq apt-transport-https ca-certificates
  - wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.asc.gpg
  - mv microsoft.asc.gpg /etc/apt/trusted.gpg.d/
  - wget -q https://packages.microsoft.com/config/debian/9/prod.list
  - mv prod.list /etc/apt/sources.list.d/microsoft-prod.list
  - apt-get update
  - apt-get install -yqq dotnet-sdk-3.0

  - haxelib install $HXML --always --quiet
  - haxe $HXML

test-neko:
  stage: build-test
  retry: 2
  variables:
    HXML: test-neko.hxml
  script:
  - haxelib install $HXML --always --quiet
  - haxe $HXML

test-cpp:
  stage: build-test
  retry: 2
  variables:
    HXML: test-cpp.hxml
  script:
  # Install C++ build tools
  - apt-get update
  - apt-get install -yqq build-essential g++
  
  - haxelib install $HXML --always --quiet
  - haxe $HXML

deploy:
  stage: deploy
  before_script:
  - apt-get update
  - apt-get install -yqq zip
  script:
  - mkdir -p build
  - zip -r build/udprotean.zip -@ < haxelib.lst
